# 去中心化通用认证登录协议

## 协议简述

去中心化通用认证登录协议（下称“协议”），采用挑战-响应的现代认证模式，免去了用户名-口令这种模式潜在的安全风险，可以为企业和服务快速带来Web 3.0的安全登录体验。

协议基于去中心化标识和可验证凭证技术，帮助用户快速登录的同时，可同时让用户根据需要向服务端授权必要信息。

协议涉及三方交互：
- 服务端
- 客户端
- 去中心化身份管理钱包（下称“钱包”）

服务端是服务依赖方，向用户提供各种服务。客户端可能是网页也可能是App，用户在客户端向服务端认证并登录。去中心化身份管理钱包是用户管理自己去中心化身份和可验证凭证等数据的管理器。

## 协议流程

整个协议按顺序可以分为以下五步：
- 认证请求：用户触发登录，并发送认证请求给服务端；
- 认证挑战：收到客户端的认证请求后，服务端生成认证挑战并发送给客户端。挑战中可包含请求的可验证凭证要求；
- 签名（和授权）：客户端收到服务器的认证挑战后，和钱包进行交互，取得对挑战的签名和相应的可验证凭证展示；
- 认证响应：客户端取得钱包提供的签名和可验证凭证展示后，对服务端发起的挑战进行响应；
- 响应验证：服务端验证客户端发送过来的响应是否正确。如果正确，则认为用户认证成功，同时解析客户端发送过来的可验证凭证展示，取得相应的用户授权信息。

### 认证请求

客户端向用户端发送认证请求，请求数据格式如下：

```json
{
 "ver": "1.0",
 "type": "ClientHello",
 "action": "1",
 "ClientChanllege"：{},
}
```

字段ver为协议版本号，字符串类型，目前协议版本号定为1.0；

字段type为消息类型，字符串类型，认证请求的消息类型应赋值为“ClientHello”；

字段action描述用户行为，8位二进制，最低位代表挑战认证，次低位代表授权，其余位暂未定义；

（可选）字段ClientChanllege为客户端挑战，在双向认证时使用。


### 认证挑战

在收到客户端的请求后，服务端生成并存储一个随机nonce。同时，根据action类型选择不同的凭证出示要求。

nonce值可以是128位的uuid或者其它随机值，应保证nonce的随机性和新鲜性。

正常情况下，服务端返回下列信息给客户端：
```json
{
"ver": "1.0",
 "type": "ServerHello",
 "nonce": "128-uuid",
 "server": {
   "name": "",
   "icon": "",
   "url": "",
   "did": "",
   "verificationMethod": "",
 },
 "chain": ["ONT","BSC"],
 "alg": ["ES256","Ed25519"],
 "VCFilters": [
   {"type": "DegreeCredential", "trustRoot":["did:ont:bob",""], "required": "true"},
   {"type": "IdentityCredential", "express":"", "required": "false"},
 ],
 "serverProof"：{},
 "extension": {},
}
```

字段ver为协议版本号，字符串类型，目前协议版本号定为1.0；

字段type为消息类型，字符串类型，认证挑战的消息类型应赋值为“ServerHello”；

字段nonce为随机挑战，由服务器生成的一次性随机数；

字段server为服务器信息，对象类型，包含以下五个字符串类型字段：
- name：必填字段，代表服务端名字；
- icon：可选字段，服务端图标的URL或者经过相应编码的图标本身；
- url：必填字段，服务端的URL；
- did：选填字段，服务端的去中心化标识，在双向认证时必填；
- verificationMethod：选填字段，服务端DID Document中验证方法的序列号，双向认证时必填；

字段VCFilters为服务器所需客户端凭证出示的类型，对象数组类型，每个对象至少包含以下三个字段：
- type：可验证凭证的种类；
- trustRoot：可验证凭证的可信颁发者；
- required：该类凭证是否必须提供；

字段chain为服务端支持的链，字符串数组类型，用链上原生通证符号表示链，例如“ONT”表示本体区块链；

字段alg为服务端对客户端签名响应的算法支持，字符串数组类型；

字段serverProof为双向认证时服务器对客户端挑战的响应，对象类型；

字段extension为扩展字段，对象类型。

### 签名（和授权）

客户端收到认证挑战后，形成待签名消息并与钱包交互，取得对挑战的签名以及服务端所请求的用户凭证展示。

待签名消息：
```json
{
  "type": "ClientResponse",
  "server": {
	"name":
	"url":
	"did":
  },
  "nonce": "128-uuid",
  "did": "did:ont:alice",
  "created":"2010-01-0119:23:24Z",
}
```

字段type为消息类型，字符串类型，签名中的消息类型应赋值为“ClientResponse”；

字段server为服务器信息，对象类型，包括server为服务器信息，对象类型，包含name、url和did三个字符串类型字段；

字段nonce为认证挑战中的随机挑战值，字符串类型；

字段did为用户去中心化标识；

字段created为创建签名时的实时时间。

### 认证响应

客户端收到钱包签名以及可验证凭证后，发送响应消息进行认证响应。

```json
{
 "ver": "1.0",
 "type": "ClientResponse",
 "nonce": "uuid-128",
 "did": "did:ont:alice",
 "proof": {
   "type":"Ed25519",
   "verificationMethod": "did:ont:alice#key-1",
   "created":"2010-01-0119:23:24Z",
   "value":"xx",
 },
 "VPs": ["",""],
}
```

字段type为消息类型，认证挑战为消息类型为“ClientResponse”；

字段nonce为服务端在挑战响应中传过来的随机挑战；

字段did为客户端用户的去中心化标识符号；

字段proof为客户端对服务器端对响应，包括：
- type为签名算法
- verificationMethod为用户did中验证方法的序列号
- created为时间戳
- value为签名值


### 认证结果

检查挑战响应是否正确：
- 检查nonce值是否和原始nonce值匹配；
- 验证签名结果；
- 检查VP是否满足要求，VP是否正确；
- 如果是非注册类型操作，应检查该DID是否已在系统用户列表中。


## 错误码

- ERR_VERSION_NOT_SUPPORTED: 认证请求的版本号不受支持
- ERR_TYPE_NOT_SUPPORTED: 认证请求的消息类型不受支持
- ERR_ACTION_NOT_SUPPORTED: 认证请求的操作行为不受支持
- ERR_UNDEFINED: 其它未定义错误
